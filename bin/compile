#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

set -e

build_dir=$1
cache_dir=$2
env_dir=$3
bp_dir=$(dirname $(dirname $0))

proc_file="Procfile"

configure_elk_syncer() {
    echo "elkSyncer: cd elkSyncer && python main.py" > $proc_file
    
cat > $build_dir/mongo-connector-config.json << EOF
{
    "oplogFile": "$build_dir/oplog.timestamp",
    "noDump": false,
    "batchSize": 5000,
    "verbosity": 3,
    "continueOnError": true,
    "logging": {
        "type": "stream"
    },
    "namespaces": {
        "erxes*.customers": {
            "rename": "erxes*__customers._doc",
            "excludeFields": ["urlVisits", "messengerData"]
        },
        "erxes*.companies": {
            "rename": "erxes*__companies._doc"
        }
    },
    "docManagers": [
        {
            "docManager": "elastic2_doc_manager",
            "bulkSize": 10,
            "uniqueKey": "_id",
            "args": {
                "clientOptions": {
                    "timeout": 5000
                }
            }
        }
    ]
}
EOF
    echo "-----> Created mongo-connector-config.json"
    
cat > $build_dir/runtime.txt << EOF
python-3.7.6
EOF
    
cat > $build_dir/requirements.txt << EOF
mongo-connector==3.1.1
elasticsearch==7.5.1
elastic2-doc-manager==1.0.0
python-dotenv==0.11.0
certifi==0.0.8
EOF
}

configure_elk_syncer
echo "-----> Done elk syncer"

exit 0